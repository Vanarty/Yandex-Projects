# Прогнозирование электроэнергии при плавке стали 

([Тетрадка с проектом](https://github.com/Vanarty/Yandex-Projects/blob/main/final_project/predict_of_electricity_in_the_steelmaking_process.ipynb))

* Автор проекта - *Иванов Артём Юрьевич*
* vanarty@yandex.ru

Чтобы оптимизировать производственные расходы, металлургический комбинат ООО «Так закаляем сталь» решил уменьшить потребление электроэнергии на этапе обработки стали. Необходимо построить модель, которая предскажет температуру стали.

**Краткое описание этапа обработки**

Сталь обрабатывают в металлическом ковше вместимостью около 100 тонн. Чтобы ковш выдерживал высокие температуры, изнутри его облицовывают огнеупорным кирпичом. Расплавленную сталь заливают в ковш и подогревают до нужной температуры графитовыми электродами. Они установлены в крышке ковша.

Из сплава выводится сера (десульфурация), добавлением примесей корректируется химический состав и отбираются пробы. Сталь легируют — изменяют её состав, добавляя куски сплава из бункера для сыпучих материалов или проволоку через специальный трайб-аппарат.

Перед тем как первый раз ввести легирующие добавки, измеряют температуру стали и производят её химический анализ. Потом температуру на несколько минут повышают, добавляют легирующие материалы и продувают сплав инертным газом. Затем сплав перемешивают и снова проводят измерения. Такой цикл повторяется до тех пор, пока не будет достигнут нужный химический состав сплава и оптимальная температура плавки.

Дальше расплавленная сталь отправляется на доводку металла или поступает в машину непрерывной разливки. Оттуда готовый продукт выходит в виде заготовок-слябов (англ. slab, «плита»).

**Целевой признак и метрикa качества**

**Целевой признак** - последняя измеренная температура в каждой партии.

Метрика качества модели, выбранная Заказчиком - **MAE**, дополнительно можно оценить метрику **R2**.

**В ходе работы было выполнено:**
- загружены данные с базы данных **PostgreSQL** - 7 таблиц. Для удобства таблицы были сохранены в отдельные файлы формата `'.csv'`;
- проведен анализ всех таблиц (проверено наличие пропусков и аномалий с последующей их обработкой, изучены распределения признаков, построены наглядные графики);
- на основе имеющихся данных построены дополнительные признаки (агреггированные, производные, временные);
- данные объеденены в итоговую таблицу. Для объединенния использован метод `'inner'`. Таким образом в итоговую таблицу попали только те партии, для которых во всех таблицах есть данные. Исключены признаки, содержащие даты;
- проведен корреляционный анализ признаков, включая целевой;
- данные были разбиты на обучающую и валидационную выборки в соотношении 75% к 25%;
- в качестве `константной baseline модели` использована модель **DummyRegressor** по `среднему значению`;
- с подбором гиперпараметров и `кросс-валидации на 5-и фолдах` с помощью **GridSearchCV** обучено **5 моделей**: **'Lasso', 'Ridge', 'RandomForestRegressor', 'LGBMRegressor', 'NeuralNetwork (Pytorch)'**;
- выбрана лучшая модель по результатам метрики **MAE**;
- лучшая модель оценена на `тестовой (отложенной)` выборке и проведено сравнение с `константной baseline моделью`;
- проведено исследование `важности признаков` для предсказания температуры плавления;
- (**дополнительно**) обучена `метамодель` на основе ансамбля базовых моделей: . Получены предсказания на тестовой выборке, оценена метрика **MAE**;
- сделан **вывод и даны рекомендации** бизнесу.

Из интересных особенностей на этапе **EDA-исследования** выявлено следующее:
- чаще всего на одну партию приходится от **4 до 5 этапов нагрева**;
- есть партии, требующие так же либо меньшего количества этапов (**от 1 до 3**) или намного большего (**от 6 до 15**);
- `активная` и `реактивная` мощности **сильно положительно коррелируют**;
- в среднем `реактивная мощность` составляет порядка **0.7-0.8** от `активной мощности`;
- `медианнаяя` длительность одного этапа нагрева составляет - **2 мин. 27 сек**;
- есть партии, которые имеют отрицательную длительность между этапами. После просмотра многих партий выявлена та же самая ошибка в данных, связанная с тем, что не всегда после полуночи дата указана с учетом следующих суток;
- `'среднее'` значение объема газа, используемого для продувки сплава составляет **11**, `'медианное'` немного меньше - **9.8**. Видимо для некоторых партий используется больший объем газа для продувки;
- `межквартильный размах` значений объема подаваемого газа - **от 0 до 24**;
- в некторых партиях используется больший объем газа вплоть до **78**;
- не все типы `проволочных` и `сыпучих` материалов добавляются в сталь. Из `сыпучих` материалов чаще всего используются материалы **№14, №12, №15**. Реже - **№3, №4, №6**. Остальные практически не используются. Из `проволочных` материалов чаще всего используются материалы **№1, №2**. Остальные практически не используются. 
- `медианное значение` **начальной температуры** нагрева немного **ниже конечной** и составляет около **1580 гр.**;
- `межквартильный размах` **начальной температуры** намного больше, чем у **конечной температуры**, что говорит о большей вариабельности;
- у обоих температур есть **выбросы**, но у **начальной температуры** есть аномально низкие значения в районе **1200 - 1235 гр.**. По условиям задачи такие температуры аномальны ('Заказчик предупредил, что значения температуры ниже 1500 градусов — аномальные'). Удалим партии с тикими аномальными температурами.

## Выводы:
В качестве итоговой модели, рекомендованной к внедрению, предлагается **Lasso** с **L1-регуляризацией**. `Средняя абсолютная ошибка` модели (метрика **MAE**) на тестовой выборке составила **6,65 градуса**, что безусловно ниже предела, установленного Заказчиком (`MAE не выше 6.8`).
Для модели **Lasso** самыми важными признаками в порядке убывания важности стали: `'active_power'`, `'reactive_power'`, `'time_between_cum'
- `начальная температура нагрева`;
- `суммарная мощность`;
- `активная мощность`;
- `реактивная мощность`;
- `суммарное время между началами этапов нагрева`.

    `Нейронная сеть` построенная с использованием **pytorch** показала хучдшие рездуьтаты, **MAE** на кросс-валидации - **6.549**. Для табличных данных быстрее и качественнее работают `линейные модели` и `модели основанные на деревьях`. `Нейронные сети` требуют подбора скрытых слоев, настройки параметров и как следствие большего времени на обучение.

    Так же крайне рекомендуется к внедрению `ансамбль из базовых моделей` (**Lasso, Ridge, RandomForest, LGBRegressor**) и метамодели **RandomForest**, которые показал на тестовой выборке значение **MAE** - **5.632**. Ансамбль моделей имеет ряд преимцществ, одним из которых является усреднение предсказательной способности базовых моделей на шумных данных и `меньшую среднюю абсолютную ошибку` .

## Рекомендации:
- предоставить Заказчику информацию о найденных ошибках в данных (ошибки в датах, отсутствие информации о разных партиях в каждой из таблиц). В случае устранения проблем с искажением и потерей данных, можно попробовать - обучить модель на большем объеме партий для улучшения предсказательной способности;
- замер предыдущей температуры нагрева с предыдущего этапа позволил бы более точно прогнозировать следующую температуру нагрева, ввиду автокорреляции.
